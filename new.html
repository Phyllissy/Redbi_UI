<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新建业务术语</title>
    <!-- 引入样式库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.13/lib/theme-chalk/index.css">
    <!-- 自定义样式 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, "Microsoft YaHei", sans-serif;
            background-color: #f5f7fa;
            color: #333;
            font-size: 14px;
            padding: 20px;
        }
        .modal-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e6e6e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-footer {
            padding: 10px 20px;
            border-top: 1px solid #e6e6e6;
            text-align: right;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
        }
        .form-control:focus {
            outline: none;
            border-color: #409eff;
        }
        .textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }
        .btn-primary {
            background-color: #409eff;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #66b1ff;
        }
        .btn-default {
            background-color: #f5f7fa;
            color: #606266;
            border: 1px solid #dcdfe6;
        }
        .btn-default:hover {
            background-color: #f0f0f0;
        }
        .required {
            color: #f56c6c;
            margin-left: 4px;
        }
        .error-message {
            display: none;
            color: #f56c6c;
            font-size: 12px;
            margin-top: 5px;
        }
        .form-control.error, .form-select.error {
            border-color: #f56c6c;
        }
        .select-container {
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            overflow: hidden;
        }
        .select-header {
            padding: 10px;
            display: flex;
            border-bottom: 1px solid #ebeef5;
        }
        .select-header .form-control {
            flex: 1;
            margin-right: 10px;
        }
        .select-body {
            display: flex;
            height: 300px;
        }
        .selected-items, .available-items {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .selected-items {
            border-right: 1px solid #ebeef5;
            background-color: #f8f9fa;
        }
        .drag-hint {
            margin-bottom: 10px;
            color: #606266;
            font-size: 13px;
        }
        .sortable-list {
            list-style: none;
            padding: 0;
        }
        .sortable-item {
            padding: 8px 10px;
            background-color: #fff;
            border: 1px solid #ebeef5;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            cursor: move;
        }
        .sortable-item .handle {
            margin-right: 10px;
            color: #909399;
            cursor: move;
        }
        .sortable-item .remove {
            margin-left: auto;
            color: #f56c6c;
            cursor: pointer;
        }
        .indicator-list {
            margin-top: 10px;
        }
        .item-header {
            color: #606266;
            font-size: 13px;
            margin-bottom: 10px;
        }
        .indicator-item {
            padding: 8px 10px;
            border-bottom: 1px solid #ebeef5;
            display: flex;
            align-items: center;
        }
        .indicator-item:last-child {
            border-bottom: none;
        }
        .item-type {
            margin-left: auto;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #f0f9eb;
            color: #67c23a;
        }
        .item-type.dimension {
            background-color: #ecf5ff;
            color: #409eff;
        }
        .condition-builder {
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            overflow: hidden;
        }
        .condition-tabs {
            display: flex;
            border-bottom: 1px solid #ebeef5;
        }
        .condition-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .condition-tab.active {
            color: #409eff;
            border-bottom-color: #409eff;
        }
        .condition-content {
            padding: 15px;
        }
        .condition-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .condition-field, .condition-operator {
            margin-right: 10px;
        }
        .condition-field {
            width: 35%;
        }
        .condition-operator {
            width: 20%;
        }
        .condition-value {
            width: 30%;
            margin-right: 10px;
        }
        .condition-add, .condition-remove {
            width: 32px;
            height: 32px;
            padding: 0;
            margin-right: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .condition-preview {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .condition-expression {
            margin-top: 8px;
            padding: 8px;
            background-color: #fff;
            border: 1px solid #ebeef5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .auto-description {
            margin-top: 5px;
        }
        .description-preview {
            padding: 15px;
            background-color: #fff;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .description-content {
            color: #606266;
        }
        .description-list {
            margin: 10px 0;
            padding-left: 20px;
        }
        .description-item {
            margin-bottom: 5px;
        }
        .tag-indicator, .tag-dimension {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .tag-indicator {
            background-color: #f0f9eb;
            color: #67c23a;
        }
        .tag-dimension {
            background-color: #ecf5ff;
            color: #409eff;
        }
        .description-condition {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ebeef5;
        }
        .condition-title {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .condition-code {
            padding: 8px 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .description-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }
        .description-actions .btn {
            margin-left: 10px;
            display: flex;
            align-items: center;
            padding: 5px 10px;
        }
        .refresh-icon, .edit-icon {
            margin-right: 5px;
        }
        .checkbox-group {
            margin-top: 10px;
        }
        .checkbox-item {
            margin-right: 15px;
            display: inline-block;
            margin-bottom: 8px;
        }
        .checkbox-input {
            margin-right: 4px;
        }
        .related-indicators {
            margin-top: 20px;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">新建业务术语</h3>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">术语名称 <span class="required">*</span></label>
                <input type="text" class="form-control" id="term-name" placeholder="请输入业务术语名称">
                <div class="error-message" id="term-name-error">请输入业务术语名称</div>
            </div>
            <div class="form-group">
                <label class="form-label">别名</label>
                <input type="text" class="form-control" placeholder="请输入别名，可选">
            </div>
            <div class="form-group">
                <label class="form-label">业务域 <span class="required">*</span></label>
                <select class="form-select" id="business-domain">
                    <option value="">请选择业务域</option>
                    <option value="community">社区</option>
                    <option value="trade">交易</option>
                    <option value="commercial">商业化</option>
                </select>
                <div class="error-message" id="business-domain-error">请选择业务域</div>
            </div>
            <div class="form-group">
                <label class="form-label">类型 <span class="required">*</span></label>
                <select class="form-select" id="term-type" onchange="handleTypeChange()">
                    <option value="">请选择类型</option>
                    <option value="condition">条件集合</option>
                    <option value="field">字段集合</option>
                </select>
                <div class="error-message" id="term-type-error">请选择类型</div>
            </div>
            <div class="form-group" id="conditionGroup" style="display: none;">
                <label class="form-label">筛选条件 <span class="required">*</span></label>
                <div class="condition-builder">
                    <div class="condition-tabs">
                        <div class="condition-tab active" data-type="indicator">指标条件</div>
                        <div class="condition-tab" data-type="dimension">维度条件</div>
                    </div>
                    <div class="condition-content">
                        <div class="condition-panel" id="indicator-conditions">
                            <div class="condition-row">
                                <select class="form-select condition-field">
                                    <option value="">请选择指标</option>
                                    <option value="ad_revenue">广告流水</option>
                                    <option value="brand_revenue">品牌广告流水</option>
                                    <option value="search_revenue">搜索广告流水</option>
                                </select>
                                <select class="form-select condition-operator">
                                    <option value="=">=</option>
                                    <option value=">">></option>
                                    <option value="<"><</option>
                                    <option value=">=">>=</option>
                                    <option value="<="><=</option>
                                    <option value="!=">!=</option>
                                </select>
                                <input type="text" class="form-control condition-value" placeholder="请输入值">
                                <button class="btn btn-default condition-add">+</button>
                                <button class="btn btn-default condition-remove">-</button>
                            </div>
                        </div>
                        <div class="condition-panel" id="dimension-conditions" style="display: none;">
                            <div class="condition-row">
                                <select class="form-select condition-field">
                                    <option value="">请选择维度</option>
                                    <option value="platform_type">平台类型</option>
                                    <option value="ad_position">广告位置</option>
                                    <option value="category_id">类目ID</option>
                                </select>
                                <select class="form-select condition-operator">
                                    <option value="=">等于</option>
                                    <option value="!=">不等于</option>
                                    <option value="IN">包含于</option>
                                    <option value="NOT IN">不包含于</option>
                                    <option value="LIKE">模糊匹配</option>
                                </select>
                                <input type="text" class="form-control condition-value" placeholder="请输入值，多个值用逗号分隔">
                                <button class="btn btn-default condition-add">+</button>
                                <button class="btn btn-default condition-remove">-</button>
                            </div>
                        </div>
                        <div class="condition-preview">
                            <label>条件预览</label>
                            <div class="condition-expression" id="condition-preview-text">
                                <!-- 条件表达式将动态显示在这里 -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="error-message" id="condition-error">请配置筛选条件</div>
            </div>
            <div class="form-group" id="indicatorGroup" style="display: none;">
                <label class="form-label">关联指标/维度 <span class="required">*</span></label>
                <div class="select-container">
                    <div class="select-header">
                        <input type="text" class="form-control" placeholder="搜索指标/维度" id="indicator-search">
                        <button class="btn btn-default search-btn">搜索</button>
                    </div>
                    <div class="select-body">
                        <div class="selected-items">
                            <div class="drag-hint">已选择 <span id="selected-count">0</span> 个，可拖动排序</div>
                            <ul id="selected-indicators" class="sortable-list">
                                <!-- 已选项将动态插入此处 -->
                            </ul>
                        </div>
                        <div class="available-items">
                            <div class="item-header">可选指标/维度</div>
                            <div class="indicator-list">
                                <div class="indicator-item" draggable="true" data-id="1">
                                    <input type="checkbox" id="indicator1" class="checkbox-input">
                                    <label for="indicator1">品牌广告流水</label>
                                    <span class="item-type">指标</span>
                                </div>
                                <div class="indicator-item" draggable="true" data-id="2">
                                    <input type="checkbox" id="indicator2" class="checkbox-input">
                                    <label for="indicator2">广告流水</label>
                                    <span class="item-type">指标</span>
                                </div>
                                <div class="indicator-item" draggable="true" data-id="3">
                                    <input type="checkbox" id="indicator3" class="checkbox-input">
                                    <label for="indicator3">搜索广告流水</label>
                                    <span class="item-type">指标</span>
                                </div>
                                <div class="indicator-item" draggable="true" data-id="4">
                                    <input type="checkbox" id="indicator4" class="checkbox-input">
                                    <label for="indicator4">广告平台</label>
                                    <span class="item-type">维度</span>
                                </div>
                                <div class="indicator-item" draggable="true" data-id="5">
                                    <input type="checkbox" id="indicator5" class="checkbox-input">
                                    <label for="indicator5">广告位置</label>
                                    <span class="item-type">维度</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="error-message" id="indicators-error">请至少选择一个指标/维度</div>
            </div>
            <div class="form-group" id="description-group">
                <label class="form-label">描述</label>
                <div class="auto-description">
                    <div class="description-preview">
                        <div class="description-content">
                            包含以下指标与维度：
                            <ul class="description-list">
                                <li class="description-item"><span class="tag-indicator">品牌广告流水</span></li>
                                <li class="description-item"><span class="tag-indicator">广告流水</span></li>
                                <li class="description-item"><span class="tag-dimension">平台类型</span></li>
                            </ul>
                            <div class="description-condition">
                                <div class="condition-title">筛选条件：</div>
                                <div class="condition-code">platform_type = 'bkfs' AND category_id IN (101, 102, 103)</div>
                            </div>
                        </div>
                    </div>
                    <div class="description-actions">
                        <button class="btn btn-default btn-sm" id="refresh-description">
                            <i class="refresh-icon">↻</i> 刷新描述
                        </button>
                        <button class="btn btn-default btn-sm" id="edit-description">
                            <i class="edit-icon">✎</i> 手动编辑
                        </button>
                    </div>
                    <textarea class="form-control textarea description-editor" style="display: none;" placeholder="手动编辑描述信息"></textarea>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">应用数据集</label>
                <div class="related-indicators">
                    <p>系统已自动获取与所选指标关联的数据集：</p>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="dataset1" class="checkbox-input" checked>
                            <label for="dataset1">广告业务数据集</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dataset2" class="checkbox-input" checked>
                            <label for="dataset2">电商交易数据集</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dataset3" class="checkbox-input" checked>
                            <label for="dataset3">流量分析数据集</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" onclick="window.location.href='index1.html'">取消</button>
            <button class="btn btn-primary" onclick="saveTerminology()">保存</button>
        </div>
    </div>

    <script>
        /**
         * 获取 URL 参数
         * @param {string} name - 参数名称
         * @returns {string} 参数值
         */
        function getUrlParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        /**
         * 初始化页面数据
         */
        function initPageData() {
            const termId = getUrlParam('id');
            
            if (termId) {
                // 修改标题为编辑模式
                document.querySelector('.modal-title').textContent = '编辑业务术语';
                
                // 加载术语数据，这里模拟从后端获取数据
                // 实际情况中，应该是发送 AJAX 请求获取数据
                loadTerminologyData(termId);
            }
        }
        
        /**
         * 加载术语数据
         * @param {string} id - 术语 ID
         */
        function loadTerminologyData(id) {
            // 模拟数据，实际应该从后端 API 获取
            const mockData = {
                id: id,
                name: '测试术语_' + id,
                alias: '测试别名',
                domain: 'trade',
                type: 'condition',
                conditions: [
                    { field: 'ad_revenue', operator: '>', value: '1000' },
                    { field: 'platform_type', operator: '=', value: 'app' }
                ],
                indicators: [1, 2, 4] // 关联指标ID列表
            };
            
            // 填充表单数据
            fillFormData(mockData);
        }
        
        /**
         * 填充表单数据
         * @param {Object} data - 术语数据
         */
        function fillFormData(data) {
            // 填充基本信息
            document.getElementById('term-name').value = data.name;
            document.querySelector('input[placeholder="请输入别名，可选"]').value = data.alias;
            document.getElementById('business-domain').value = data.domain;
            
            // 设置类型并触发显示相应区域
            const termTypeSelect = document.getElementById('term-type');
            termTypeSelect.value = data.type;
            handleTypeChange();
            
            // 如果是条件类型，设置条件
            if (data.type === 'condition' && data.conditions && data.conditions.length > 0) {
                setupConditions(data.conditions);
            }
            
            // 设置关联指标/维度
            if (data.indicators && data.indicators.length > 0) {
                setupSelectedIndicators(data.indicators);
            }
        }
        
        /**
         * 设置条件数据
         * @param {Array} conditions - 条件数组
         */
        function setupConditions(conditions) {
            // 清空现有条件行
            document.getElementById('indicator-conditions').innerHTML = '';
            document.getElementById('dimension-conditions').innerHTML = '';
            
            conditions.forEach(condition => {
                let panel;
                // 根据字段名判断是指标还是维度，简单示例
                if (['ad_revenue', 'brand_revenue', 'search_revenue'].includes(condition.field)) {
                    panel = document.getElementById('indicator-conditions');
                } else {
                    panel = document.getElementById('dimension-conditions');
                }
                
                // 创建条件行
                const row = document.createElement('div');
                row.className = 'condition-row';
                row.innerHTML = `
                    <select class="form-select condition-field">
                        <option value="">请选择</option>
                        <option value="ad_revenue">广告流水</option>
                        <option value="brand_revenue">品牌广告流水</option>
                        <option value="search_revenue">搜索广告流水</option>
                        <option value="platform_type">平台类型</option>
                        <option value="ad_position">广告位置</option>
                        <option value="category_id">类目ID</option>
                    </select>
                    <select class="form-select condition-operator">
                        <option value="=">=</option>
                        <option value=">">></option>
                        <option value="<"><</option>
                        <option value=">=">>=</option>
                        <option value="<="><=</option>
                        <option value="!=">!=</option>
                        <option value="IN">包含于</option>
                        <option value="NOT IN">不包含于</option>
                        <option value="LIKE">模糊匹配</option>
                    </select>
                    <input type="text" class="form-control condition-value" placeholder="请输入值">
                    <button class="btn btn-default condition-add">+</button>
                    <button class="btn btn-default condition-remove">-</button>
                `;
                
                // 设置选中值
                row.querySelector('.condition-field').value = condition.field;
                row.querySelector('.condition-operator').value = condition.operator;
                row.querySelector('.condition-value').value = condition.value;
                
                panel.appendChild(row);
            });
            
            // 更新条件预览
            updateConditionPreview();
        }
        
        /**
         * 设置选中的指标/维度
         * @param {Array} indicatorIds - 指标/维度 ID 数组
         */
        function setupSelectedIndicators(indicatorIds) {
            // 选中对应的复选框
            indicatorIds.forEach(id => {
                const checkbox = document.querySelector(`.indicator-item[data-id="${id}"] .checkbox-input`);
                if (checkbox) {
                    checkbox.checked = true;
                    
                    // 触发点击事件来添加到已选列表
                    const event = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(event);
                }
            });
        }
        
        /**
         * 保存业务术语
         */
        function saveTerminology() {
            if (validateForm()) {
                const termId = getUrlParam('id');
                const actionType = termId ? '更新' : '新建';
                
                // 获取表单数据
                const formData = {
                    id: termId || new Date().getTime(), // 如果没有 ID，生成一个
                    name: document.getElementById('term-name').value,
                    alias: document.querySelector('input[placeholder="请输入别名，可选"]').value,
                    domain: document.getElementById('business-domain').value,
                    type: document.getElementById('term-type').value,
                    // 其他数据收集...
                };
                
                // 这里应该发送 AJAX 请求将数据保存到后端
                // 模拟保存成功
                alert(`${actionType}业务术语成功`);
                
                // 返回到列表页面
                window.location.href = 'index1.html';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化页面数据
            initPageData();
            
            // 设置其他功能
            setupConditionTabs();
            setupConditionBuilder();
            setupIndicatorSelection();
            setupDescriptionEditor();
        });

        /**
         * 处理类型变化
         */
        function handleTypeChange() {
            const select = document.getElementById('term-type');
            const conditionGroup = document.getElementById('conditionGroup');
            const indicatorGroup = document.getElementById('indicatorGroup');
            
            if (!select.value) {
                conditionGroup.style.display = 'none';
                indicatorGroup.style.display = 'none';
            } else {
                indicatorGroup.style.display = 'block';
                
                if (select.value === 'condition') {
                    conditionGroup.style.display = 'block';
                } else {
                    conditionGroup.style.display = 'none';
                }
            }
        }

        /**
         * 表单验证
         * @returns {boolean} 验证结果
         */
        function validateForm() {
            let isValid = true;
            
            // 验证术语名称
            const termName = document.getElementById('term-name');
            const termNameError = document.getElementById('term-name-error');
            if (!termName.value.trim()) {
                termName.classList.add('error');
                termNameError.style.display = 'block';
                isValid = false;
            } else {
                termName.classList.remove('error');
                termNameError.style.display = 'none';
            }
            
            // 验证业务域
            const businessDomain = document.getElementById('business-domain');
            const businessDomainError = document.getElementById('business-domain-error');
            if (!businessDomain.value) {
                businessDomain.classList.add('error');
                businessDomainError.style.display = 'block';
                isValid = false;
            } else {
                businessDomain.classList.remove('error');
                businessDomainError.style.display = 'none';
            }
            
            // 验证类型
            const termType = document.getElementById('term-type');
            const termTypeError = document.getElementById('term-type-error');
            if (!termType.value) {
                termType.classList.add('error');
                termTypeError.style.display = 'block';
                isValid = false;
            } else {
                termType.classList.remove('error');
                termTypeError.style.display = 'none';
                
                // 根据类型验证相关字段
                if (termType.value === 'condition') {
                    // 验证条件
                    const conditionPreview = document.getElementById('condition-preview-text');
                    const conditionError = document.getElementById('condition-error');
                    if (!conditionPreview.textContent.trim()) {
                        conditionError.style.display = 'block';
                        isValid = false;
                    } else {
                        conditionError.style.display = 'none';
                    }
                }
                
                // 验证指标/维度
                const selectedCount = document.getElementById('selected-count');
                const indicatorsError = document.getElementById('indicators-error');
                if (parseInt(selectedCount.textContent) === 0) {
                    indicatorsError.style.display = 'block';
                    isValid = false;
                } else {
                    indicatorsError.style.display = 'none';
                }
            }
            
            return isValid;
        }

        /**
         * 设置条件标签页切换
         */
        function setupConditionTabs() {
            const tabs = document.querySelectorAll('.condition-tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 获取当前容器
                    const container = this.closest('.condition-builder');
                    
                    // 移除所有active类
                    container.querySelectorAll('.condition-tab').forEach(t => t.classList.remove('active'));
                    container.querySelectorAll('.condition-panel').forEach(p => p.style.display = 'none');
                    
                    // 添加active类到当前点击的标签
                    this.classList.add('active');
                    
                    // 显示对应的面板
                    const type = this.getAttribute('data-type');
                    document.getElementById(`${type}-conditions`).style.display = 'block';
                });
            });
        }

        /**
         * 设置条件构建器
         */
        function setupConditionBuilder() {
            // 添加条件行
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('condition-add')) {
                    const row = e.target.closest('.condition-row');
                    const panel = row.parentNode;
                    const newRow = row.cloneNode(true);
                    
                    // 清空新行的值
                    newRow.querySelectorAll('select, input').forEach(el => {
                        if (el.tagName === 'SELECT') {
                            el.selectedIndex = 0;
                        } else {
                            el.value = '';
                        }
                    });
                    
                    panel.appendChild(newRow);
                    updateConditionPreview();
                }
            });
            
            // 删除条件行
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('condition-remove')) {
                    const row = e.target.closest('.condition-row');
                    const panel = row.parentNode;
                    
                    // 确保至少保留一行
                    if (panel.querySelectorAll('.condition-row').length > 1) {
                        panel.removeChild(row);
                        updateConditionPreview();
                    }
                }
            });
            
            // 监听条件字段变化，更新预览
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('condition-field') || 
                    e.target.classList.contains('condition-operator')) {
                    updateConditionPreview();
                }
            });
            
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('condition-value')) {
                    updateConditionPreview();
                }
            });
        }

        /**
         * 更新条件预览
         */
        function updateConditionPreview() {
            const indicatorRows = document.querySelectorAll('#indicator-conditions .condition-row');
            const dimensionRows = document.querySelectorAll('#dimension-conditions .condition-row');
            const previewElement = document.getElementById('condition-preview-text');
            
            let conditions = [];
            
            // 处理指标条件
            indicatorRows.forEach(row => {
                const field = row.querySelector('.condition-field').value;
                const operator = row.querySelector('.condition-operator').value;
                const value = row.querySelector('.condition-value').value;
                
                if (field && operator && value) {
                    if (isNaN(value)) {
                        conditions.push(`${field} ${operator} '${value}'`);
                    } else {
                        conditions.push(`${field} ${operator} ${value}`);
                    }
                }
            });
            
            // 处理维度条件
            dimensionRows.forEach(row => {
                const field = row.querySelector('.condition-field').value;
                const operator = row.querySelector('.condition-operator').value;
                const value = row.querySelector('.condition-value').value;
                
                if (field && operator && value) {
                    if (operator === 'IN' || operator === 'NOT IN') {
                        const values = value.split(',').map(v => `'${v.trim()}'`).join(', ');
                        conditions.push(`${field} ${operator} (${values})`);
                    } else if (operator === 'LIKE') {
                        conditions.push(`${field} ${operator} '%${value}%'`);
                    } else {
                        conditions.push(`${field} ${operator} '${value}'`);
                    }
                }
            });
            
            previewElement.textContent = conditions.join(' AND ');
            
            // 同时更新描述预览
            updateDescriptionPreview();
        }

        /**
         * 设置指标/维度选择和排序
         */
        function setupIndicatorSelection() {
            // 复选框选择
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('checkbox-input')) {
                    const item = e.target.closest('.indicator-item');
                    const id = item.getAttribute('data-id');
                    const label = item.querySelector('label').textContent;
                    const type = item.querySelector('.item-type').textContent;
                    
                    const selectedList = document.getElementById('selected-indicators');
                    
                    if (e.target.checked) {
                        // 添加到已选列表
                        const li = document.createElement('li');
                        li.className = 'sortable-item';
                        li.setAttribute('data-id', id);
                        li.setAttribute('draggable', 'true');
                        li.innerHTML = `
                            <span class="handle">⋮⋮</span>
                            <span class="item-name">${label}</span>
                            <span class="item-type ${type === '维度' ? 'dimension' : ''}">${type}</span>
                            <span class="remove" onclick="removeSelectedItem(this, ${id})">×</span>
                        `;
                        selectedList.appendChild(li);
                    } else {
                        // 从已选列表中移除
                        const selectedItem = selectedList.querySelector(`[data-id="${id}"]`);
                        if (selectedItem) {
                            selectedList.removeChild(selectedItem);
                        }
                    }
                    
                    // 更新已选计数
                    updateSelectedCount();
                    
                    // 更新描述预览
                    updateDescriptionPreview();
                }
            });
            
            // 设置排序功能
            setupSortable();
        }

        /**
         * 设置排序功能
         */
        function setupSortable() {
            const selectedList = document.getElementById('selected-indicators');
            
            // 简单的拖拽排序实现
            let draggedItem = null;
            
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('sortable-item')) {
                    draggedItem = e.target;
                    setTimeout(() => {
                        e.target.style.opacity = '0.5';
                    }, 0);
                }
            });
            
            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('sortable-item')) {
                    e.target.style.opacity = '1';
                    draggedItem = null;
                }
            });
            
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            selectedList.addEventListener('dragenter', function(e) {
                e.preventDefault();
                const targetItem = e.target.closest('.sortable-item');
                if (targetItem && targetItem !== draggedItem) {
                    const rect = targetItem.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    
                    if (y < rect.height / 2) {
                        selectedList.insertBefore(draggedItem, targetItem);
                    } else {
                        selectedList.insertBefore(draggedItem, targetItem.nextSibling);
                    }
                    
                    // 更新描述预览
                    updateDescriptionPreview();
                }
            });
        }

        /**
         * 移除已选项
         * @param {HTMLElement} element - 被点击的移除按钮
         * @param {string} id - 项目ID
         */
        function removeSelectedItem(element, id) {
            // 移除已选列表中的项
            const item = element.closest('.sortable-item');
            item.parentNode.removeChild(item);
            
            // 取消对应复选框的选中状态
            const checkbox = document.querySelector(`.indicator-item[data-id="${id}"] .checkbox-input`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            // 更新已选计数
            updateSelectedCount();
            
            // 更新描述预览
            updateDescriptionPreview();
        }

        /**
         * 更新已选计数
         */
        function updateSelectedCount() {
            const count = document.querySelectorAll('#selected-indicators .sortable-item').length;
            document.getElementById('selected-count').textContent = count;
        }

        /**
         * 更新描述预览
         */
        function updateDescriptionPreview() {
            const selectedItems = document.querySelectorAll('#selected-indicators .sortable-item');
            const conditionExpression = document.getElementById('condition-preview-text').textContent;
            const descriptionContent = document.querySelector('.description-content');
            
            // 先清空预览内容
            descriptionContent.innerHTML = '';
            
            // 分离指标和维度
            let indicators = [];
            let dimensions = [];
            
            selectedItems.forEach(item => {
                const name = item.querySelector('.item-name').textContent;
                const type = item.querySelector('.item-type').textContent;
                
                if (type.includes('维度')) {
                    dimensions.push(name);
                } else {
                    indicators.push(name);
                }
            });
            
            // 构建HTML内容
            let html = '包含以下指标与维度：<ul class="description-list">';
            
            // 添加指标
            indicators.forEach(name => {
                html += `<li class="description-item"><span class="tag-indicator">${name}</span></li>`;
            });
            
            // 添加维度
            dimensions.forEach(name => {
                html += `<li class="description-item"><span class="tag-dimension">${name}</span></li>`;
            });
            
            html += '</ul>';
            
            // 添加条件部分
            if (conditionExpression) {
                html += `
                    <div class="description-condition">
                        <div class="condition-title">筛选条件：</div>
                        <div class="condition-code">${conditionExpression}</div>
                    </div>
                `;
            }
            
            descriptionContent.innerHTML = html;
        }

        /**
         * 设置描述编辑功能
         */
        function setupDescriptionEditor() {
            const editDescBtn = document.getElementById('edit-description');
            const refreshDescBtn = document.getElementById('refresh-description');
            const descPreview = document.querySelector('.description-preview');
            const descEditor = document.querySelector('.description-editor');
            
            if (editDescBtn) {
                editDescBtn.addEventListener('click', function() {
                    if (descEditor.style.display === 'none') {
                        // 切换到编辑模式
                        descEditor.style.display = 'block';
                        descPreview.style.display = 'none';
                        this.innerHTML = '<i class="edit-icon">↻</i> 返回预览';
                        
                        // 从预览生成文本到编辑器
                        const descContent = generateDescriptionText();
                        descEditor.value = descContent;
                    } else {
                        // 切换回预览模式
                        descEditor.style.display = 'none';
                        descPreview.style.display = 'block';
                        this.innerHTML = '<i class="edit-icon">✎</i> 手动编辑';
                    }
                });
            }
            
            if (refreshDescBtn) {
                refreshDescBtn.addEventListener('click', function() {
                    updateDescriptionPreview();
                });
            }
        }

        /**
         * 从选中的指标和条件生成描述文本
         * @returns {string} 生成的描述文本
         */
        function generateDescriptionText() {
            const selectedItems = document.querySelectorAll('#selected-indicators .sortable-item');
            const conditionExpression = document.getElementById('condition-preview-text').textContent;
            
            let indicatorNames = [];
            let dimensionNames = [];
            
            selectedItems.forEach(item => {
                const name = item.querySelector('.item-name').textContent;
                const type = item.querySelector('.item-type').textContent;
                
                if (type.includes('维度')) {
                    dimensionNames.push(name);
                } else {
                    indicatorNames.push(name);
                }
            });
            
            let text = '';
            
            if (indicatorNames.length > 0) {
                text += `包含${indicatorNames.join('、')}等${indicatorNames.length}个指标`;
            }
            
            if (dimensionNames.length > 0) {
                if (text) text += '，';
                text += `包含${dimensionNames.join('、')}等${dimensionNames.length}个维度`;
            }
            
            if (conditionExpression) {
                if (text) text += '，';
                text += `筛选条件为${conditionExpression}`;
            }
            
            return text || '暂无描述信息';
        }
    </script>
</body>
</html>